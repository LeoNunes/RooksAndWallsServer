# AWS Deployment Requirements (Games Backend)

This folder contains deployment artifacts for running the backend on an EC2 instance via CodeDeploy.

The backend is expected to run behind Nginx with TLS termination and websocket proxying.

## Runtime Architecture

- Application process (`games.service`) listens on `127.0.0.1:${GAMES_PORT:-8080}`.
- Nginx is the public entrypoint on ports `80` and `443`.
- DNS for environment must point to the instance EIP.
- TLS certificates are managed with Certbot (`webroot` flow).

## Required Environment Files

### `/etc/games/infra.env` (written by infrastructure/CDK)

Infrastructure must provide these variables:

- `GAMES_PORT` (port to run the application)
- `GAMES_ENVIRONMENT` (lowercase, for example `beta`)
- `GAMES_SECRET_NAME` (for beta: `games/beta/secrets`)
- `GAMES_SERVER_NAME` (for example `beta.api.games.leonunes.me`)
- `GAMES_HOSTED_ZONE_NAME` (for example `leonunes.me`)

Optional (used for Certbot contact email):

- `LETSENCRYPT_EMAIL` or `GAMES_OPS_EMAIL`
- If neither is present, deployment falls back to `ops@${GAMES_HOSTED_ZONE_NAME}`

### `/etc/games/service.env` (written during deployment)

- Generated by `after_install.sh` from AWS Secrets Manager secret JSON.
- Must contain only runtime/application secrets as `KEY=VALUE` lines.
- File permissions are restricted to root (`600`).

## Secrets Manager Contract

- Secret name is read from `GAMES_SECRET_NAME` in `/etc/games/infra.env`.
- Script fetches with:
  - `aws secretsmanager get-secret-value --secret-id "$GAMES_SECRET_NAME" --query SecretString --output text`
- Secret value must be a JSON object.
- JSON entries are transformed into shell-safe `KEY=VALUE` lines in `/etc/games/service.env`.

## Nginx Contract

`application_start.sh` renders `/etc/nginx/conf.d/games-${GAMES_ENVIRONMENT}.conf` from one of two templates in `aws/nginx/`, deployed to `/opt/games/nginx/`:

- **`games-http.conf.tmpl`** — HTTP-only config used during first deployment while certs don't exist yet:
  - Serves `/.well-known/acme-challenge/` from `/var/www/certbot` for the Certbot webroot challenge.
  - Redirects all other traffic to HTTPS.
- **`games-https.conf.tmpl`** — Full config used once certs are present:
  - All of the above HTTP block, plus an HTTPS server block (`:443`) that:
    - Uses certs from `/etc/letsencrypt/live/${GAMES_SERVER_NAME}/`.
    - Proxies to `http://127.0.0.1:${GAMES_PORT}`.
    - Sets websocket and forwarding headers.
    - Configures long read/send timeouts for websocket stability.

Templates are rendered with `envsubst`. Nginx variables (e.g. `$host`, `$uri`) are preserved as-is; only `${GAMES_SERVER_NAME}` and `${GAMES_PORT}` are substituted.

Nginx config is validated with `nginx -t` before every service operation.

## CodeDeploy Hooks

### `before_install.sh`

- Installs deployment dependencies (`nginx`, `certbot`, `awscli`, `jq`, `gettext`, Java runtime).
- Ensures required directories:
  - `/etc/games`
  - `/var/www/certbot`
- Applies ownership/mode for `/etc/games` (`root:root`, `755`).
- Enables Nginx at boot.

### `after_install.sh`

- Loads and validates `/etc/games/infra.env`.
- Fetches secrets from Secrets Manager and writes `/etc/games/service.env`.

### `application_start.sh`

- Installs/updates unit file at `/etc/systemd/system/games.service`.
- Runs:
  - `systemctl daemon-reload`
  - `systemctl enable games`
  - `systemctl restart games`
  - `systemctl enable nginx`
- Certificate lifecycle:
  - If cert is missing: renders `games-http.conf.tmpl` → starts Nginx → issues cert via `certbot certonly --webroot` → renders `games-https.conf.tmpl` → reloads Nginx.
  - If cert exists: renders `games-https.conf.tmpl` → restarts Nginx → runs `certbot renew --quiet --deploy-hook "systemctl reload nginx"`.
- Validates Nginx config with `nginx -t` before each service operation.

### `application_stop.sh`

- Stops backend service safely (`systemctl stop games || true`).
- Does not stop Nginx during normal rolling deployments.

## appspec.yml Expectations

`appspec.yml` must continue to:

- Copy build artifact contents to `/opt/games/`.
- Execute lifecycle hooks:
  - `ApplicationStop` -> `scripts/codedeploy/application_stop.sh`
  - `BeforeInstall` -> `scripts/codedeploy/before_install.sh`
  - `AfterInstall` -> `scripts/codedeploy/after_install.sh`
  - `ApplicationStart` -> `scripts/codedeploy/application_start.sh`

## IAM Requirement (EC2 Instance Role)

The instance role must allow:

- `secretsmanager:GetSecretValue` for the environment secret ARN (`GAMES_SECRET_NAME`).

This is expected to be provisioned by the infrastructure/CDK stack.
